{% extends 'base.html' %}
{% load custom_tags %} {# Asegúrate de que custom_tags es el nombre correcto de tu app o módulo de tags #}

{% block content %}

<style>
    /* Contenedor principal para el detalle del blog */
    .blog-post-container {
        max-width: 900px; /* Ancho máximo para el contenido del blog */
        margin: 40px auto; /* Centrar el contenedor con margen superior/inferior */
        padding: 2.5rem; /* Espacio interno generoso */
        background-color: #ffffff;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    /* Título del blog */
    .blog-post-container h2 {
        color: #343a40;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        line-height: 1.2;
        text-align: center; /* Centrar el título del blog */
    }

    /* Información del autor y fecha */
    .blog-post-container .text-muted {
        font-size: 0.95rem;
        color: #6c757d !important;
        margin-bottom: 1.5rem;
        text-align: center; /* Centrar la información del autor/fecha */
    }

    /* ********** Estilos para el CONTENIDO generado por TinyMCE (blog.contenido|safe) ********** */
    .blog-content {
        line-height: 1.7; /* Mejor legibilidad general */
        font-size: 1.1rem; /* Tamaño de fuente para el texto del cuerpo */
        color: #343a40; /* Color del texto principal */
        word-wrap: break-word; /* ¡CORRECCIÓN: Rompe palabras muy largas! */
        overflow-wrap: break-word; /* ¡CORRECCIÓN: Para mayor compatibilidad! */
    }

    .blog-content p {
        margin-bottom: 1rem; /* Espacio entre párrafos */
    }

    .blog-content h1,
    .blog-content h2,
    .blog-content h3,
    .blog-content h4,
    .blog-content h5,
    .blog-content h6 {
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: #495057;
        font-weight: 600;
        line-height: 1.2; /* Altura de línea para encabezados */
    }

    .blog-content h1 { font-size: 2.2rem; }
    .blog-content h2 { font-size: 1.8rem; }
    .blog-content h3 { font-size: 1.6rem; }
    .blog-content h4 { font-size: 1.4rem; }
    .blog-content h5 { font-size: 1.2rem; }
    .blog-content h6 { font-size: 1rem; }

    .blog-content ul,
    .blog-content ol {
        margin-bottom: 1rem;
        padding-left: 2rem; /* Aumenta la sangría para listas */
    }

    .blog-content li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }

    .blog-content a {
        color: #007bff;
        text-decoration: underline;
    }

    .blog-content a:hover {
        color: #0056b3;
        text-decoration: none;
    }

    .blog-content blockquote {
        border-left: 5px solid #007bff;
        padding: 1rem 1.2rem;
        margin: 1.5rem 0;
        background-color: #e9f0f9;
        font-style: italic;
        color: #555;
        border-radius: 0.25rem;
    }

    .blog-content pre {
        background-color: #e9ecef; /* Un gris un poco más oscuro para bloques de código */
        padding: 1rem;
        border-radius: 0.25rem;
        overflow-x: auto;
        word-wrap: break-word; /* Romper palabras largas en código */
    }

    .blog-content code {
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        font-size: 0.9em; /* Ligeramente más pequeño para código inline */
        color: #e83e8c;
    }

    .blog-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1.5rem auto; /* Centrar imágenes del contenido */
        display: block; /* Necesario para margin: auto */
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1); /* Sombra para imágenes */
    }

    /* Estilos para el video URL si existe una imagen de vista previa */
    .blog-post-container .video-preview {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 1.5rem auto;
        border-radius: 0.5rem;
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
    }
    .blog-post-container .btn-outline-secondary {
        display: block; /* Botón de video en su propia línea */
        width: fit-content; /* Ancho ajustado al contenido */
        margin: 1rem auto; /* Centrar botón de video */
    }


    /* Botones de acción (Volver, Eliminar) */
    .action-buttons-container {
        max-width: 900px;
        margin: 20px auto;
        display: flex;
        justify-content: space-between; /* Espacio entre los botones */
        align-items: center;
    }
    .back-button, .delete-form .btn-danger {
        font-size: 1rem;
        padding: 0.6rem 1.2rem;
        border-radius: 0.3rem;
    }
    .delete-form {
        margin: 0; /* Eliminar margen si se usaba antes */
    }


    /* Comentarios */
    .comments-section {
        max-width: 900px;
        margin: 3rem auto; /* Centrar sección de comentarios */
        padding-top: 2rem;
        border-top: 1px solid #dee2e6;
    }

    .comments-section h3 {
        color: #343a40;
        margin-bottom: 1.5rem;
        font-size: 1.75rem;
    }

    .comment-form {
        margin-bottom: 2rem; /* Espacio debajo del formulario de comentarios */
        padding: 1.5rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .comment-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    .comment-form textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        box-sizing: border-box;
    }
    .comment-form button[type="submit"] {
        padding: 10px 20px;
        border-radius: 0.25rem;
    }

    /* Estilos para los errores del formulario de comentarios */
    .comment-form .alert-danger {
        margin-bottom: 1rem;
        padding: 0.75rem 1.25rem;
        border-radius: 0.25rem;
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    .comment-form .alert-danger ul {
        margin-bottom: 0;
        padding-left: 1.5rem;
    }

</style>

{# Contenedor para los botones de acción #}
<div class="action-buttons-container">
    <a href="{% url 'lista_blogs' %}" class="btn btn-primary back-button">
        <i class="bi bi-arrow-left"></i> Volver a la lista
    </a>
    {% if user.is_staff or user|has_group:"educador" %}
    <form method="POST" action="{% url 'eliminar_blog' blog.id %}" onsubmit="return confirm('¿Estás seguro de eliminar esta publicación?');" class="delete-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Eliminar publicación
        </button>
    </form>
    {% endif %}
</div>

{# Contenedor principal del post del blog #}
<div class="blog-post-container">
    <h2 class="mb-3">{{ blog.titulo }}</h2>
    <p class="text-muted">Publicado por {{ blog.autor.username }} el {{ blog.fecha_creacion|date:"d/m/Y H:i" }}</p>

    {% if blog.imagen %}
        <div class="text-center mb-4">
            <img src="{{ blog.imagen.url }}" alt="Imagen del blog: {{ blog.titulo }}" class="img-fluid rounded" style="max-width: 100%; height: auto;">
        </div>
    {% endif %}

    <div class="blog-content mb-4">
        {{ blog.contenido|safe }}
    </div>

    {% if blog.video_url %}
        <div class="mb-3 text-center">
            <a href="{{ blog.video_url }}" target="_blank" class="btn btn-outline-secondary">
                <i class="bi bi-play-circle"></i> Ver Video
            </a>
        </div>
    {% endif %}
</div>

<div class="comments-section">
    <h3 class="mb-4">Comentarios</h3>

    {% if comentarios %}
        {% include "blogs/comentario_tree.html" with comentarios=comentarios nivel=0 %}
    {% else %}
        <p class="text-muted">No hay comentarios aún. ¡Sé el primero en comentar!</p>
    {% endif %}

    <h3 class="mt-5 mb-3">Agregar comentario</h3>
    {% if user.is_authenticated %}
        <form method="POST" class="mt-3 comment-form">
            {% csrf_token %}
            {% if form.errors %}
                <div class="alert alert-danger">
                    Por favor corrige los errores:
                    <ul>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li>{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            {# ********** INICIO DEL CAMBIO ********** #}
            {# Renderizado individual del campo del formulario de comentario principal #}
            <div class="mb-3">
                <label for="{{ form.contenido.id_for_label }}" class="form-label visually-hidden">Tu comentario:</label>
                {{ form.contenido }} {# Esto renderizará el textarea del comentario #}
                {% if form.contenido.errors %}
                    <div class="text-danger">{{ form.contenido.errors }}</div>
                {% endif %}
            </div>
            {# ********** FIN DEL CAMBIO ********** #}

            <button type="submit" class="btn btn-success mt-3">
                <i class="bi bi-chat-dots"></i> Comentar
            </button>
            <hr class="mt-4">
        </form>
    {% else %}
        <p class="text-muted">Debes <a href="{% url 'account_login' %}" class="text-decoration-underline">iniciar sesión</a> para comentar.</p>
    {% endif %}
</div>


<script>
    function mostrarRespuesta(id) {
        const form = document.getElementById('respuesta-form-' + id);
        if (form) {
            form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
        }
    }
</script>

{% endblock %}