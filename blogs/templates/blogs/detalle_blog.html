{% extends 'base.html' %}
{% block content %}

<!-- Botón para volver -->
<a href="{% url 'lista_blogs' %}" class="btn btn-primary mt-3">Volver a la lista</a>

<!-- Tarjeta del blog -->
<div class="card mt-4 p-4 shadow-sm">
  <h2 class="mb-3">{{ blog.titulo }}</h2>
  <p class="text-muted">Publicado por {{ blog.autor.username }} el {{ blog.fecha_creacion|date:"d/m/Y H:i" }}</p>
  <div class="mb-3">{{ blog.contenido|safe }}</div>

  <!-- Imagen del blog -->
  {% if blog.imagen %}
    <img src="{{ blog.imagen.url }}" alt="Imagen del blog: {{ blog.titulo }}" class="img-fluid rounded mb-3" style="max-width: 100%; height: auto;">
  {% endif %}

  <!-- Video del blog -->
  {% if blog.video_url %}
    <div class="mb-3">
      <a href="{{ blog.video_url }}" target="_blank" class="btn btn-outline-secondary">Ver Video</a>
    </div>
  {% endif %}
</div>

<hr>
<h3>Comentarios</h3>

<!-- Mostrar comentarios -->
{% if comentarios %}
  {% for comentario in comentarios %}
    <div class="border p-3 mb-3 rounded">
      <strong class="{% if comentario.autor == request.user %}text-primary{% endif %}">
        {{ comentario.autor.username }}
      </strong>:
      <p>{{ comentario.contenido }}</p>
      <small class="text-muted">{{ comentario.fecha_creacion|date:"d/m/Y H:i" }}</small><br>

      <!-- Botón de responder -->
      <button type="button" class="btn btn-link p-0" onclick="mostrarRespuesta({{ comentario.id }});">Responder</button>

      <!-- Formulario de respuesta oculto -->
      <div id="respuesta-form-{{ comentario.id }}" style="display: none; margin-top: 10px;">
        <form method="POST">
          {% csrf_token %}
          {{ form.as_p }}
          <input type="hidden" name="respuesta_a" value="{{ comentario.id }}">
          <button type="submit" class="btn btn-sm btn-outline-primary">Responder</button>
        </form>
      </div>

      <!-- Respuestas anidadas -->
      {% for respuesta in comentario.respuestas.all %}
        <div class="ms-4 mt-3 ps-3 border-start">
          <strong>{{ respuesta.autor.username }}</strong> respondió:
          <p>{{ respuesta.contenido }}</p>
          <small class="text-muted">{{ respuesta.fecha_creacion|date:"d/m/Y H:i" }}</small>
        </div>
      {% endfor %}
    </div>
  {% endfor %}
{% else %}
  <p class="text-muted">No hay comentarios aún.</p>
{% endif %}

<!-- Formulario para agregar un nuevo comentario -->
<hr>
<h3>Agregar comentario</h3>
<form method="POST" class="mt-3">
  {% csrf_token %}
  {% if form.errors %}
    <div class="alert alert-danger">
      Por favor corrige los errores.
    </div>
  {% endif %}
  {{ form.as_p }}
  <button type="submit" class="btn btn-success">Comentar</button>
</form>

<!-- Script para mostrar formulario de respuesta -->
<script>
function mostrarRespuesta(id) {
  const form = document.getElementById('respuesta-form-' + id);
  if (form) form.style.display = 'block';
}
</script>

{% endblock %}