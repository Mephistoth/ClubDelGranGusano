{% load blogs_filters %} {# <-- ¡Añade esta línea! #}

{% for comentario in comentarios %}
  {% with margen=nivel|add:1 %}
    <div class="card mb-3 comment-card" style="margin-left: {{ margen }}rem;">
      <div class="card-body">
        
        {# Línea vertical para indicar anidamiento (ahora dentro del card-body si es necesario) #}
        {% if nivel > 0 %}
          <div class="comment-line-indicator" style="position: absolute; left: -1rem; top: 0; bottom: 0; border-left: 1px dashed #ccc;"></div>
        {% endif %}
        
        <h6 class="card-title mb-1">
          <strong class="{% if comentario.autor == request.user %}text-primary{% endif %}">{{ comentario.autor.username }}</strong>
          <small class="text-muted ms-2">{{ comentario.fecha_creacion|date:"d/m/Y H:i" }}</small>
        </h6>
        
        <p class="card-text mt-2 mb-2">{{ comentario.contenido }}</p>

        {# Botón de responder #}
        <button type="button" class="btn btn-link btn-sm p-0" onclick="mostrarRespuesta({{ comentario.id }});">Responder</button>

        {# Formulario de respuesta oculto #}
        <div id="respuesta-form-{{ comentario.id }}" class="mt-3" style="display: none;">
          <form method="POST">
            {% csrf_token %}
            
            <div class="mb-2"> {# Margen inferior menor para este grupo de campo #}
                <label for="{{ form.contenido.id_for_label }}" class="form-label visually-hidden">Tu respuesta:</label> 
                {{ form.contenido|add_class:"form-control" }} {# Esto ahora debería funcionar #}
                {% if form.contenido.errors %}
                    <div class="text-danger mt-1">{{ form.contenido.errors }}</div>
                {% endif %}
            </div>
            
            <input type="hidden" name="respuesta_a" value="{{ comentario.id }}">
            <button type="submit" class="btn btn-primary btn-sm">Enviar respuesta</button>
          </form>
        </div>

        {# Recursión para las respuestas anidadas #}
        {% if comentario.respuestas.exists %}
          <div class="mt-3 nested-comments">
            {% include "blogs/comentario_tree.html" with comentarios=comentario.respuestas.all nivel=nivel|add:1 %}
          </div>
        {% endif %}
      </div>
    </div>
  {% endwith %}
{% endfor %}